package com.example.english_exam.services.ExamAndTest;

import com.example.english_exam.dto.request.AnswerRequest;
import com.example.english_exam.dto.response.user.AnswerResponse;
import com.example.english_exam.dto.request.QuestionRequest;
import com.example.english_exam.dto.response.user.QuestionResponse;
import com.example.english_exam.models.Answer;
import com.example.english_exam.models.Passage;
import com.example.english_exam.models.Question;
import com.example.english_exam.models.TestQuestion;
import com.example.english_exam.repositories.*;
import com.example.english_exam.services.ApiExtend.GeminiService;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
public class QuestionService {
    private final QuestionRepository questionRepository;
    private final PassageRepository passageRepository;
    private final AnswerRepository answerRepository;
    private final SkillRepository skillRepository;
    private final GeminiService geminiService;
    private final TestQuestionRepository testQuestionRepository;

    public QuestionService(QuestionRepository questionRepository,
                           PassageRepository passageRepository,
                           AnswerRepository answerRepository,
                           SkillRepository skillRepository,
                           GeminiService geminiService,
                           TestQuestionRepository testQuestionRepository) {
        this.questionRepository = questionRepository;
        this.passageRepository = passageRepository;
        this.answerRepository = answerRepository;
        this.skillRepository = skillRepository;
        this.geminiService = geminiService;
        this.testQuestionRepository = testQuestionRepository;
    }

    public List<Question> findAll() {
        return questionRepository.findAll();
    }

    public Optional<Question> findById(Long id) {
        return questionRepository.findById(id);
    }

    public List<Question> findByExamPart(Long examPartId) {
        return questionRepository.findByExamPartId(examPartId);
    }

    public Question save(Question question) {
        return questionRepository.save(question);
    }

    public QuestionResponse createQuestionWithAnswers(QuestionRequest request) {

        Passage passage = null;
        Long passageId = request.getPassageId();

        // 1. Nếu có passageContent hoặc mediaUrl thì tạo passage mới
        if ((request.getPassageContent() != null && !request.getPassageContent().isEmpty())
                || (request.getMediaUrl() != null && !request.getMediaUrl().isEmpty())) {

            passage = new Passage();
            passage.setContent(request.getPassageContent());
            passage.setMediaUrl(request.getMediaUrl());
            passage.setPassageType(request.getPassageType());
            passage = passageRepository.save(passage);

            passageId = passage.getPassageId();
        }

        // 2. Tạo question
        Question question = new Question();
        question.setExamPartId(request.getExamPartId());
        question.setPassageId(passageId); // null nếu không tạo passage và không có passageId
        question.setQuestionText(request.getQuestionText());
        question.setQuestionType(request.getQuestionType());
        question = questionRepository.save(question);

        // 3. Tạo answers
        List<Answer> answerEntities = new ArrayList<>();
        if (request.getAnswers() != null && !request.getAnswers().isEmpty()) {
            switch (question.getQuestionType()) {
                case MCQ:
                    for (AnswerRequest ar : request.getAnswers()) {
                        Answer ans = new Answer();
                        ans.setQuestionId(question.getQuestionId());
                        ans.setAnswerText(ar.getAnswerText());
                        ans.setIsCorrect(ar.getIsCorrect());
                        ans.setAnswerLabel(ar.getAnswerLabel());
                        answerEntities.add(answerRepository.save(ans));
                    }
                    break;

                case FILL_BLANK:
                    AnswerRequest ar = request.getAnswers().get(0);
                    Answer ans = new Answer();
                    ans.setQuestionId(question.getQuestionId());
                    ans.setAnswerText(ar.getAnswerText());
                    ans.setIsCorrect(true);
                    ans.setAnswerLabel(ar.getAnswerLabel());
                    answerEntities.add(answerRepository.save(ans));
                    break;

                case ESSAY:
                    // ESSAY: user tự viết, không cần tạo answer
                    break;

                default:
                    throw new IllegalArgumentException("Unknown question type: " + question.getQuestionType());
            }
        }

        // 4. Sinh explanation nếu chưa có, truyền cả passage nếu có
        if (question.getExplanation() == null || question.getExplanation().isEmpty()) {
            String explanation = geminiService.explainQuestion(question, answerEntities, passage);
            question.setExplanation(explanation);
            question = questionRepository.save(question);
        }

        // 5. Chuyển answers sang DTO
        List<AnswerResponse> answerResponses = answerEntities.stream()
                .map(a -> new AnswerResponse(a.getAnswerId(), a.getAnswerText(), a.getIsCorrect(), a.getAnswerLabel()))
                .collect(Collectors.toList());

        // 6. Gán câu hỏi vào test_part nếu có
        if (request.getTestPartId() != null) {
            TestQuestion tq = new TestQuestion();
            tq.setTestPartId(request.getTestPartId());
            tq.setQuestionId(question.getQuestionId());
            testQuestionRepository.save(tq);
        }

        // 7. Trả về response
        return new QuestionResponse(
                question.getQuestionId(),
                question.getExamPartId(),
                question.getPassageId(),
                question.getQuestionText(),
                question.getQuestionType(),
                question.getExplanation(),
                answerResponses,
                request.getTestPartId()
        );
    }



    public void deleteById(Long id) {
        questionRepository.deleteById(id);
    }
}
